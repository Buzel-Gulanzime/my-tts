<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オフライン長時間読み上げ</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f4f9; padding: 20px; }
        textarea { width: 100%; height: 300px; border-radius: 10px; border: 1px solid #ccc; padding: 10px; font-size: 16px; }
        .controls { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 10px; background: #007aff; color: white; font-weight: bold; font-size: 1rem; }
        button:active { opacity: 0.7; }
        #status { margin-top: 10px; font-size: 0.8rem; color: #666; text-align: center; }
    </style>
</head>
<body>

    <textarea id="textInput" placeholder="ここに長文をペーストしてください..."></textarea>
    
    <div class="controls">
        <button id="startBtn">再生</button>
        <button id="stopBtn" style="background: #ff3b30;">停止</button>
    </div>
    
    <div id="status">準備完了</div>

    <audio id="silentAudio" loop>
        <source src="silent.mp3" type="audio/mpeg">
    </audio>

    <script>
        const synth = window.speechSynthesis;
        const textInput = document.getElementById('textInput');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const silentAudio = document.getElementById('silentAudio');
        const status = document.getElementById('status');

        let utterance = null;

        startBtn.onclick = () => {
            if (synth.speaking) return;

            // 1. 無音再生を開始（バックグラウンド維持の鍵）
            silentAudio.play().catch(e => console.log("Audio play failed"));

            // 2. 読み上げの設定
            utterance = new SpeechSynthesisUtterance(textInput.value);
            utterance.lang = 'ja-JP';
            utterance.rate = 1.0;

            // 長時間再生バグ対策：10秒ごとにresumeを呼ぶ
            const keepAlive = setInterval(() => {
                if (!synth.speaking) {
                    clearInterval(keepAlive);
                } else {
                    synth.pause();
                    synth.resume();
                }
            }, 10000);

            utterance.onstart = () => { status.innerText = "読み上げ中..."; };
            utterance.onend = () => { 
                status.innerText = "完了";
                silentAudio.pause();
            };

            synth.speak(utterance);
        };

        stopBtn.onclick = () => {
            synth.cancel();
            silentAudio.pause();
            status.innerText = "停止中";
        };
    </script>
</body>
</html>
